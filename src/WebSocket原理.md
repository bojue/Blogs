# WebSocket原理和应用

### 1. WebSocket 概念

WebScoket是HTML5提供，由同一个TCP连接实现的全双工通信协议。2011年被IETF定为标准RFC 6455。

### 2. WebSocket 解决了什么问题

HTTP是单向应用层传输协议，采用请求相应的形式进行通信，并且请求只能由客户端发起服务器相应的形式交互，服务器不能主动发送消息到客户端，简单的Http无法实现服务器消息推送的功能。

HTTP通信协议开发中，客户端为了实时获取服务器最新的数据，一般可以采用以下多种方式实现：

1. 定时轮询：通过Ajax定时发起请求，握手，服务器返回数据，关闭连接，定时重复
2. 长轮询：通过Ajax发送请求，握手，连接打开直到服务器数据更新，返回数据，关闭连接，重复
3. 长连接：通过客户端发送请求，握手，连接打开知道服务器数据更新，返回数据，关闭连接

无论采用什么样的方式都有各自存在各自的缺点：

定时轮询：每次轮询服务器数据不一定发生变化，网络通信也会经过三次握手和数据相应的过程；服务器数据改变，客户端可能没有及时的发起轮询请求，数据实时性不能保证。消息获取效率不高，浪费宽带和服务器资源

长连接和长轮询：当服务器没有数据更新的情况下，http连接一段时间内处于打开状态，损害服务器的整体性能，影响服务器的并发数目；长轮询需要每次连接握手过程的时间和性能开销

为了优化网络性能开销，从底层解决服务器和客户端实时通信问题，WebSocket就是构建在TCP上不同于HTTP/HTTP2.0的新的协议方案，被W3C定位标准。

### 3. WebSocket 原理

WebSocket 是独立构建在TCP上的全双工通信协议，为了兼容基础的网络设施和网络策略，WebSocket共用了HTTP协议的握手过程，用户为了安全和保密对外仅开发有限网络端口，WebSocket也默认使用HTTP的默认端口,即Http 80，Https 443端口，WebSocket未来可能会定制自己的端口，用来实现更简单的握手过程(RFC 6455)。

相对于以上双向通信方案WebSocket有以下优点：

1.性能开销更少：握手完成后，客户端和服务器进行数据通信时，控制协议通信的数据头部信息更小
2.实时性更好：WebSocket是全双工通信，连接保持打开状态，无论是客户端到服务器还是服务器到客户端，请求和实时数据实时发送和相应，通信存在更少的时间延时。
3.二进制支持：WebSocket支持文本和二进制数据内容，相对于HTTP可以很简单的实现对二进制数据的操作。
4.支持扩展：WebSocket定义了扩展接口，WebSocket.extensions 属性查看服务器支持的扩展列表。
5.支持压缩：可以通过压缩优化数据内容的大小。

### 4. WebSocket 使用

### 5. 总结

有些基础的网络设备可能不支持WebSocket，在使用WebSocket可能存在兼容性问题，导致盲目连接升级，内容修改，意外缓存WebSocket数据帧，代理网络可能屏蔽WebSocket,在WebSocket握手之前进行TLS连接，在服务器和客户端建立安全的网络通道，绕开中间代理实现可靠的数据传输。


## 参考:
1. [WebSockets 简介](https://www.html5rocks.com/zh/tutorials/websockets/basics/#toc-introduction-lowlatency)
2. [MDN: WebSocket](https://developer.mozilla.org/zh-CN/docs/Web/API/WebSocket)
3. [WebScoket 详细教程](https://www.cnblogs.com/jingmoxukong/p/7755643.html)
4. 《Web性能权威指南》