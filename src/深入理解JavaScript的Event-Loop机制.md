# 深入理解JavaScript的Event-Loop机制

JavaScript是单线程脚本语言，执行环境每个时刻只能执行一个JavaScipt任务。

JavaScript分为同步事件和异步事件，触发事件需要立即返回结果的是同步事件，触发事件暂时不需要立即返回结果的是异步事件，在等待异步返回结果的过程中可以处理其他事件。

对于异步事件处理，JavaScript执行环境主线程不需要等待收到返回结果，而是先讲异步事件回调存储到事件队列中，主线程继续执行执行栈的其他任务，当前异步事件返回结果后，被挂起的异步任务在执行栈继续按照顺序执行。

#### Event-Loop机制

Event-Loop是实现JavaScript异步的一种机制。

JavaScript 事件队列分为两种：宏任务（macro-task）队列和微任务（micro-task）队列。
 
+ 宏任务（macro-task）是离散的独立任务，比如创建DOM对象，执行全局JavaScript代码，宏任务执行完成之后可以执行其他事件，比如浏览器垃圾回收。

    常见的宏任务：I/O，setTimeout，setInterval，执行全局JavaScript代码，UI交互事件，postMessage，setImmediate（Node.js）

+ 微任务（micro-task）是更小的任务，在其他任务执行之前执行，比如Promise执行方法，微任务一般通过异步执行或者需要立即执行的并且不产全新的微任务的事件。微任务是在浏览器UI重新渲染之前执行。

    常见的微任务：Promise， MutationObserver，process.nextTick（Node.js)

事件循环通过两个原则处理浏览器事件，一是单线程处理方式，二是事件在执行过程中不会被其他事件中断（除非浏览器自己决定主动终端某个事件，比如浏览器主动关闭一些处理事件时间过长的事件进程，一般很少发生）。

事件循环过程：

1. 事件循环首先检查宏队列列表，如果队列存在等待宏任务，则执行（2），否则直接执行（3）。
2. 执行宏任务列表的第1个等待处理事件，执行完成从宏任务队列移除该事件，执行（3）。
3. 执行微任务列表的第1个处理事件，处理完成从微任务列表移除该事件，如果还有等待的微任务，则重复（3）直到微任务列表为空，否则直接执行（4）。
4. 检查是否需要更新UI视图，如果是则执行（5），否则返回（1）开始新的循环过程。
5. UI页面渲染，返回（1）开始新的循环过程。

在事件循环一个完整的迭代过程中，宏任务最多只执行一次，微任务队列则全部被执行，微任务主要目的是为了在下一次UI重绘之前更新程序状态。

微任务优先处理权，微任务队列执行完成之前会阻止浏览器UI渲染。

UI渲染发生在两个宏任务之间，并且UI渲染开始时微任务队列为空。

JavaScript 的事件队列的执行和添加是两个完全独立的过程，确保在事件循环过程中将浏览器监听到的新事件添加到对应事件队列中去，当前执行的事件处理不受影响。



#### 参考
1. [JS浏览器事件循环机制](https://www.cnblogs.com/yqx0605xi/p/9267827.html)
2. [JavaScript忍者秘籍（第二版）](https://book.douban.com/subject/30143702/)
3. [详解JavaScript中的Event Loop（事件循环）机制](https://www.cnblogs.com/cangqinglang/p/8967268.html)












